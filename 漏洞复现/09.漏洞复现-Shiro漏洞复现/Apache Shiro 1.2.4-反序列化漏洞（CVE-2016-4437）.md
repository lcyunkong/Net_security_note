# Apache Shiro 1.2.4-反序列化漏洞（CVE-2016-4437）

### 0x00 前言

Apache Shiro是一款开源安全框架，提供身份验证、授权、密码学和会话管理。Shiro框架直观、易用，同时也能提供健壮的安全性。

Apache Shiro 1.2.4及以前版本中，加密的用户信息序列化后存储在名为remember-me的Cookie中。攻击者可以使用Shiro的默认密钥伪造用户Cookie，触发Java反序列化漏洞，进而在目标机器上执行任意命令。

影响版本：

```
shiro <= 1.2.4
```



### 0x01 环境搭建

这里使用的vulhub的靶场`shiro/CVE-2016-4437`

![image-20230411152330638](https://cdn.jsdelivr.net/gh/lcyunkong/images_map@main/img/image-20230411152330638.png)

服务启动后，访问`http://your-ip:8080`可使用`admin:vulhub`进行登录。

### 0x02 漏洞复现-Shiro-550

shiro-550主要是由shiro的rememberMe内容反序列化导致的命令执行漏洞，造成的原因是默认加密密钥是硬编码在shiro源码中，任何有权访问源代码的人都可以知道默认加密密钥。于是攻击者可以创建一个恶意对象，对其进行序列化、编码，然后将其作为cookie的rememberMe字段内容发送，Shiro 将对其解码和反序列化，导致服务器运行一些恶意代码。

1、准备工具：ShiroExploit by 飞鸿（https://github.com/feihong-cs/ShiroExploit-Deprecated）

2、填入url，执行扫描

![image-20230411153243558](https://cdn.jsdelivr.net/gh/lcyunkong/images_map@main/img/image-20230411153243558.png)

3、选择使用ceye.io 进行检测

![image-20230411153437146](https://cdn.jsdelivr.net/gh/lcyunkong/images_map@main/img/image-20230411153437146.png)

4、获取扫描结果，发现可用Gadget

![image-20230411153037233](https://cdn.jsdelivr.net/gh/lcyunkong/images_map@main/img/image-20230411153037233.png)

5、选择简便操作，执行反弹shell

![image-20230411153213309](https://cdn.jsdelivr.net/gh/lcyunkong/images_map@main/img/image-20230411153213309.png)

### 0x03 修复建议-Shiro-550

1、更新shiro到1.2.4以上的版本。

2、不使用默认的加密密钥，改为随机生成密钥。

### 0x04 漏洞复现-Shiro-721

Shiro-721反序列化漏洞，使用由于Shiro通过 使用AES-128-CBC 模式进行cookie中rememberMe字段的加密，于是用户可通过Padding Oracle加密生成的攻击代码来构造恶意的rememberMe字段，并重新请求网站，进行反序列化攻击，最终导致任意代码执行。

1、填入正确的账户密码`admin:vulhub`进行登录，使用burpsuite抓包，查看响应可以发现rememberMe字段

![image-20230411165051482](https://cdn.jsdelivr.net/gh/lcyunkong/images_map@main/img/image-20230411165051482.png)

2、将url和rememberMe字段填入工具后，选择使用ceye.io 进行检测

![image-20230411153437146](https://cdn.jsdelivr.net/gh/lcyunkong/images_map@main/img/image-20230411153437146.png)

3、爆破时间较长，结果如下

![image-20230411164741690](https://cdn.jsdelivr.net/gh/lcyunkong/images_map@main/img/image-20230411164741690.png)

4、开始反弹shell，时间依然很长

![image-20230411170945097](https://cdn.jsdelivr.net/gh/lcyunkong/images_map@main/img/image-20230411170945097.png)

### 0x05 修复建议-Shiro-721

1、将shiro升级至安全的版本。

2、关闭rememberMe持久化登录功能。

